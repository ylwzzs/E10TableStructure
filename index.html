<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>表结构多维筛选索引</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body { padding: 2rem; }
        .table-hover tbody tr:hover { background: #f5f5f5; }
        .modal-dialog { max-width: 900px; }
        .field-table th, .field-table td { font-size: 0.95rem; }
        .filter-row { margin-bottom: 1rem; }
        .filter-label { min-width: 80px; }
        .filter-info { 
            font-size: 0.85rem; 
            color: #6c757d; 
            margin-top: 0.25rem; 
        }
        .cascade-indicator {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 0.5rem;
            margin-bottom: 1rem;
            border-radius: 0.25rem;
        }
    </style>
</head>
<body>
    <h1>表结构多维筛选索引</h1>
    
    <!-- 级联筛选提示 -->
    <div class="cascade-indicator">
        <strong>级联筛选说明：</strong>
        <ul class="mb-0">
            <li>选择模块后，数据库下拉框将只显示该模块下的数据库</li>
            <li>选择数据库后，表名搜索框将提供该数据库下的表名建议</li>
            <li>中文名词搜索将根据当前筛选条件提供相关建议</li>
            <li>所有筛选条件都会相互影响，实现精确筛选</li>
        </ul>
    </div>

    <div class="row filter-row">
        <div class="col-md-2">
            <label class="filter-label">模块/微服务</label>
            <select id="moduleFilter" class="form-select">
                <option value="">全部</option>
            </select>
            <div class="filter-info" id="moduleInfo"></div>
        </div>
        <div class="col-md-2">
            <label class="filter-label">所属数据库</label>
            <select id="dbFilter" class="form-select">
                <option value="">全部</option>
            </select>
            <div class="filter-info" id="dbInfo"></div>
        </div>
        <div class="col-md-2">
            <label class="filter-label">中文名词</label>
            <input id="commentFilter" type="text" class="form-control" placeholder="模糊搜索" list="commentSuggestions">
            <datalist id="commentSuggestions"></datalist>
            <div class="filter-info" id="commentInfo"></div>
        </div>
        <div class="col-md-2">
            <label class="filter-label">表名</label>
            <input id="nameFilter" type="text" class="form-control" placeholder="模糊搜索" list="nameSuggestions">
            <datalist id="nameSuggestions"></datalist>
            <div class="filter-info" id="nameInfo"></div>
        </div>
        <div class="col-md-2">
            <label class="filter-label">描述</label>
            <input id="descFilter" type="text" class="form-control" placeholder="模糊搜索" list="descSuggestions">
            <datalist id="descSuggestions"></datalist>
            <div class="filter-info" id="descInfo"></div>
        </div>
        <div class="col-md-2">
            <label class="filter-label">操作</label>
            <button id="clearFilters" class="btn btn-outline-secondary btn-sm w-100">清除筛选</button>
            <div class="filter-info" id="resultInfo"></div>
        </div>
    </div>

    <table class="table table-bordered table-hover" id="tableList">
        <thead class="table-light">
            <tr>
                <th>表名</th>
                <th>中文名词</th>
                <th>模块/微服务</th>
                <th>所属数据库</th>
                <th>描述</th>
                <th>跳转</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <script>
    let tables = [];
    let filteredTables = [];

    fetch('all_tables.json')
      .then(res => res.json())
      .then(data => {
        tables = data;
        filteredTables = [...tables];
        initFilters();
        renderTable();
        updateFilterInfo();
      });

    function unique(arr) {
      return Array.from(new Set(arr.filter(x => x && x.trim()))).sort();
    }

    function getCurrentFilteredData() {
      let moduleVal = document.getElementById('moduleFilter').value;
      let dbVal = document.getElementById('dbFilter').value;
      let commentVal = document.getElementById('commentFilter').value.trim();
      let nameVal = document.getElementById('nameFilter').value.trim();
      let descVal = document.getElementById('descFilter').value.trim();

      return tables.filter(t => {
        return (!moduleVal || (t.module || '') === moduleVal)
          && (!dbVal || (t.db_name || '') === dbVal)
          && (!commentVal || (t.table_comment || '').includes(commentVal))
          && (!nameVal || (t.table_name || '').includes(nameVal))
          && (!descVal || (t.description || '').includes(descVal));
      });
    }

    function updateCascadeFilters() {
      const currentData = getCurrentFilteredData();
      
      // 更新数据库下拉框
      updateDbFilter(currentData);
      
      // 更新搜索建议
      updateSearchSuggestions(currentData);
    }

    function updateDbFilter(currentData) {
      const dbFilter = document.getElementById('dbFilter');
      const currentDbValue = dbFilter.value;
      
      // 清空现有选项（保留"全部"）
      dbFilter.innerHTML = '<option value="">全部</option>';
      
      // 根据当前筛选条件获取可用的数据库
      const availableDbs = unique(currentData.map(t => t.db_name || ''));
      
      availableDbs.forEach(db => {
        const opt = document.createElement('option');
        opt.value = db;
        opt.textContent = db;
        dbFilter.appendChild(opt);
      });
      
      // 如果当前选中的数据库不在可用列表中，清空选择
      if (currentDbValue && !availableDbs.includes(currentDbValue)) {
        dbFilter.value = '';
      }
    }

    function updateSearchSuggestions(currentData) {
      // 更新表名建议
      const nameSuggestions = document.getElementById('nameSuggestions');
      nameSuggestions.innerHTML = '';
      const tableNames = unique(currentData.map(t => t.table_name || ''));
      tableNames.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        nameSuggestions.appendChild(opt);
      });

      // 更新中文名词建议
      const commentSuggestions = document.getElementById('commentSuggestions');
      commentSuggestions.innerHTML = '';
      const comments = unique(currentData.map(t => t.table_comment || ''));
      comments.forEach(comment => {
        const opt = document.createElement('option');
        opt.value = comment;
        commentSuggestions.appendChild(opt);
      });

      // 更新描述建议
      const descSuggestions = document.getElementById('descSuggestions');
      descSuggestions.innerHTML = '';
      const descriptions = unique(currentData.map(t => t.description || ''));
      descriptions.forEach(desc => {
        const opt = document.createElement('option');
        opt.value = desc;
        descSuggestions.appendChild(opt);
      });
    }

    function updateFilterInfo() {
      const currentData = getCurrentFilteredData();
      const totalCount = tables.length;
      const filteredCount = currentData.length;
      
      // 更新结果信息
      document.getElementById('resultInfo').textContent = 
        `显示 ${filteredCount}/${totalCount} 条记录`;
      
      // 更新各筛选器的可用选项数量
      const moduleVal = document.getElementById('moduleFilter').value;
      const dbVal = document.getElementById('dbFilter').value;
      
      if (moduleVal) {
        const moduleCount = currentData.filter(t => t.module === moduleVal).length;
        document.getElementById('moduleInfo').textContent = `该模块下 ${moduleCount} 个表`;
      } else {
        document.getElementById('moduleInfo').textContent = '';
      }
      
      if (dbVal) {
        const dbCount = currentData.filter(t => t.db_name === dbVal).length;
        document.getElementById('dbInfo').textContent = `该数据库下 ${dbCount} 个表`;
      } else {
        document.getElementById('dbInfo').textContent = '';
      }
    }

    function initFilters() {
      // 初始化模块下拉框
      const modules = unique(tables.map(t => t.module || ''));
      const moduleSel = document.getElementById('moduleFilter');
      modules.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m;
        opt.textContent = m;
        moduleSel.appendChild(opt);
      });

      // 初始化数据库下拉框
      const dbs = unique(tables.map(t => t.db_name || ''));
      const dbSel = document.getElementById('dbFilter');
      dbs.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d;
        opt.textContent = d;
        dbSel.appendChild(opt);
      });

      // 绑定事件
      moduleSel.addEventListener('change', () => {
        updateCascadeFilters();
        renderTable();
        updateFilterInfo();
      });
      
      dbSel.addEventListener('change', () => {
        updateCascadeFilters();
        renderTable();
        updateFilterInfo();
      });
      
      document.getElementById('commentFilter').addEventListener('input', () => {
        updateCascadeFilters();
        renderTable();
        updateFilterInfo();
      });
      
      document.getElementById('nameFilter').addEventListener('input', () => {
        updateCascadeFilters();
        renderTable();
        updateFilterInfo();
      });
      
      document.getElementById('descFilter').addEventListener('input', () => {
        updateCascadeFilters();
        renderTable();
        updateFilterInfo();
      });

      // 清除筛选按钮
      document.getElementById('clearFilters').addEventListener('click', () => {
        document.getElementById('moduleFilter').value = '';
        document.getElementById('dbFilter').value = '';
        document.getElementById('commentFilter').value = '';
        document.getElementById('nameFilter').value = '';
        document.getElementById('descFilter').value = '';
        
        updateCascadeFilters();
        renderTable();
        updateFilterInfo();
      });
    }

    function renderTable() {
      const currentData = getCurrentFilteredData();
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';
      
      currentData.forEach(t => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${t.table_name || ''}</td>
          <td>${t.table_comment || ''}</td>
          <td>${t.module || ''}</td>
          <td>${t.db_name || ''}</td>
          <td>${t.description || ''}</td>
          <td><a href="${t.file}" target="_blank" class="btn btn-sm btn-success">跳转</a></td>
        `;
        tbody.appendChild(tr);
      });
    }
    </script>
</body>
</html>
